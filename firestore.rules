
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow reads and writes only for authenticated users
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // --- Lorry Receipt Uniqueness Rule ---
    // This rule prevents a new lorry receipt from being created if another
    // document with the same company, branch, and financial year combination
    // already exists with the same lrNumber.
    match /companies/{companyId}/lorryReceipts/{receiptId} {
      allow create: if request.auth != null && !exists(
        /databases/$(database)/documents/companies/$(companyId)/lorryReceipts/
          .where('companyCode', '==', request.resource.data.companyCode)
          .where('branchCode', '==', request.resource.data.branchCode)
          .where('financialYear', '==', request.resource.data.financialYear)
          .where('lrNumber', '==', request.resource.data.lrNumber)
      );

      // Allow updates and deletes for authenticated users
      allow update, delete: if request.auth != null;
    }

    // --- Sequence Counter Protection ---
    // Only allow incrementing the serial number. This prevents tampering.
    match /sequences/{companyId}/branches/{branchCode}/years/{financialYear}/documents/lrSequence {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      (
                        // Allow creation
                        !exists(resource.data) ||
                        // Allow incrementing by 1 only
                        request.resource.data.currentSerial == resource.data.currentSerial + 1
                      );
    }
  }
}
